#!/bin/bash
#
#   vagrant - script - provision
#




    # export - noninteractive
    export DEBIAN_FRONTEND=noninteractive
    set -x


    # | aptitude

        # apt - update
        aptitude update

        # apt - upgrade
        aptitude upgrade -q -y

        # apt - install - lamp / git / realpath / tree
        aptitude install -q -y apache2 mysql-server php5-mysql php5 libapache2-mod-php5 php5-mcrypt git realpath tree

        # apt - cleanup
        apt-get autoremove

    # aptitude |


    # | git

        # git - clone - aln
        if [ -d '/opt/aln' ]; then
            cd '/opt/aln' && git pull
        else
            git clone 'https://github.com/local-user/aln.git' '/opt/aln'
        fi

    # git |


    # | system
    if [ -d '/tmp/system' ]; then

        # remove existing
        [ -d '/opt/system' ] && rm -rf '/opt/system'

        # move
        mv '/tmp/system' '/opt/system'

        # ownership - app/www
        chown -R root:root '/opt/system'
                      find '/opt/system' -type f -exec chmod 644 {} \;
                      find '/opt/system' -type d -exec chmod 755 {} \;

        # '/opt/system/ -> /'
        /bin/bash /opt/aln/bin/aln -s '/opt/system' -d '/'

    fi
    # system |


    # | miv
    if [ -d '/tmp/app' ]; then

        # backup - img
        if [ -d '/var/www/webroot/img' ]; then
            rm -r '/tmp/app/webroot/img'
            mv    '/var/www/webroot/img' '/tmp/app/webroot/img'
        fi

        # remove existing
        [ -d '/var/www' ] && rm -rf '/var/www'

        # move
        mv '/tmp/app' '/var/www'

        # database - app/config
        cp '/var/www/config/database.php.sample' '/var/www/config/database.php'

        # ownership - app/www
        chown -R root:root '/var/www'
                      find '/var/www' -type f -exec chmod 644 {} \;
                      find '/var/www' -type d -exec chmod 755 {} \;

        # ownership - img - upload
        chown -R root:www-data '/var/www/webroot/img'
        chmod -R 770           '/var/www/webroot/img'

        # sql - create - database - miv
        mysql -u root < '/var/www/sql/create-database.sql'

    fi
    # miv |


    # | restart

        # restart - apache2
        service apache2 reload

        # restart - sshd
        service ssh reload

    # restart |




#
#   %(#.0)?-
#
